<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" type="text/css" href="bootstrap/bootstrap.css" >
        <link rel="stylesheet" type="text/css" href="elechart/elechart.css" >
        <link rel="stylesheet" type="text/css" href="fontawesome/css/all.min.css" >
        <link rel="icon" type="image/x-icon" href="images/favicon.ico">
        <script defer src="bootstrap/bootstrap.bundle.min.js"></script>
        <script defer src="scripts/clientutils.js"></script>
        <title>Patient Inquiry</title>
    </head>
    <body>
        <div class="d-flex overflow-x-hidden" id="wrapper">
            <!-- Sidebar -->
            <div class="bg-white" id="sidebar-wrapper">
                <div class="sidebar-heading text-center py-4 color-elechart-deep fs-4 fw-bold text-uppercase border-bm"><i class="fas fa-user me-2"></i>Portal</div>
                <div class="list-group list-group-flush">
                    <button type="button" class="btn btn-success rounded-0 mb-1 fw-bold disabled" id="service-btn" onclick="clientUtils.goto('PatientDashboard')">
                        <i class="fas fa-user-md me-2"></i>Service Patient</button>
                    <button type="button" class="btn btn-success rounded-0 mb-1 fw-bold" onclick="clientUtils.goto('Demographic')"><i class="fas fa-user-tag me-2"></i>Register New Patient</button>
                    <button type="button" class="btn btn-danger rounded-0 fw-bold" onclick="closeSession()">
                        <i class="fas fa-arrow-alt-circle-left me-2"></i>Close Session</button>
                  </div>
            </div>

            <!-- Page Content & Nav Bar -->
            <div class="bg-elechart-light" id="page-content-wrapper">
                <nav class="navbar navbar-expand-lg navbar-light bg-transparent py-4 px-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-align-left primary-text fs-4 me-3" id="menu-toggle"></i>
                        <h2 class="fs-2 m-0">Patient Inquiry</h2>
                    </div>
    
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
    
                    <div class="collapse navbar-collapse me-3" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle fw-bold" href="#" id="navbarDropdown"
                                    role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user me-2"></i>John Doe</a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="#">Profile</a></li>
                                    <li><a class="dropdown-item" href="#">Settings</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </nav>

                <!-- Patient History List -->
                <div class="container-fluid px-4">
                    <div class="bg-white rounded p-3 shadow-sm" id="patients-list-window">
                        <div class="row row-cols-4 g-2" id="patients-list">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

<script>
    "use strict"

    var loadedUICards = [];

    // This object represents a client entry in the dashboard's clients list.
    function ClientCard(clientLastName, clientFirstName, clientDOB, clientID) {
        // TODO: admittance, discharge and evaluation statuses
        this.clientLastName = clientLastName;
        this.clientFirstName = clientFirstName;
        this.clientID = clientID;
        this.clientDOB = clientDOB;
        this.cardID = "card" + clientID;
        this.referenceCard = new DOMParser().parseFromString(`
            <div class="col">
                <button class="btn-elechart text-start">
                    <h5 class="fw-bold m-0">${clientLastName}, ${clientFirstName}</h5>
                    <h6 class="m-0">${clientDOB}</h6>
                    <small>#${clientID}</small>
                </button>
            </div>`, "text/html").querySelector(".col");

        this.select = function() {
            loadedUICards.forEach(card => {
                if (this !== card)
                    card.deselect();
                
                document.querySelector("#service-btn").classList.remove("disabled");
            });
            
            this.referenceCard.querySelector(".btn-elechart").classList.add("selected");
            
            clientUtils.setCookie("clientID", this.clientID);
            clientUtils.setCookie("clientFriendlyName", `${clientLastName}, ${clientFirstName}`);
        }

        this.deselect = function() {
            this.referenceCard.querySelector(".btn-elechart").classList.remove("selected");
        }
    }   
    
    //Handles the response from the server for the client response
    function responseCallback(serverResponse) {
        //Alert and return if failed
        if (serverResponse.outcome == "failed") {
            alert("Post Failed: " + serverResponse.responseType);
            return;
        }

        console.log(serverResponse);

        clientUtils.delCookie("clientID");
        clientUtils.delCookie("clientFriendlyName");

        let clients = serverResponse.clients;

        if (clients.length == 0)
            console.warn("There are no clients to read from!");

        for (let i = 0; i < clients.length; i++) {
            const newUICard = new ClientCard(clients[i].lastName, clients[i].firstName, clientUtils.ISOToLaymanDate(clients[i].DOB), clients[i].clientId);

            newUICard.referenceCard.addEventListener("click", () => newUICard.select(), false);
            loadedUICards.push(newUICard);
            document.getElementById("patients-list").appendChild(newUICard.referenceCard);
        }

        // Store the server response as preloaded data.
        if (!sessionStorage.getItem("preloadedPatientInquiryData"))
            sessionStorage.setItem("preloadedPatientInquiryData", JSON.stringify( {clients: clients} ));

        //clientUtils.setLoadingStatus(false, "loading-patients-display");
    }

    function patientSearchSort(showAll)
    {
        let lookupName = document.getElementById("lookup-name").value;
        let lookupDOB = document.getElementById("lookup-dob").value;

        let averagePercentages = 0;

        loadedUICards.forEach(card => {
            let containsName = `${card.clientLastName} ${card.clientFirstName}`.toLowerCase().includes(lookupName.toLowerCase());
            let containsNameReversed = `${card.clientFirstName} ${card.clientLastName}`.toLowerCase().includes(lookupName.toLowerCase());
            let DOBComponents = lookupDOB.split("-");
            let [containsYear, containsMonth, containsDay] = [card.clientDOB.includes(DOBComponents[0]), card.clientDOB.includes(DOBComponents[1]), card.clientDOB.includes(DOBComponents[2])];
            
            // Show all cards if name field is empty.
            if (showAll) {
                card.referenceCard.parentElement.style.display = "block";
                return;
            }

            // Not using name field to search.
            if (lookupName.length == 0)
                containsName = containsNameReversed = false;

            if (containsName || containsNameReversed)
                card.referenceCard.parentElement.style.display = "block";
            else {
                if (DOBComponents.length > 1 && (containsYear || containsMonth || containsDay))
                    card.referenceCard.parentElement.style.display = "block";
                else
                    card.referenceCard.parentElement.style.display = "none";
            }
        });
    }

    function closeSession() {
        clientUtils.burnSession();
        document.location.href = "Login.html";
    }

    //On window load we get a list of the user's available clients
    document.addEventListener("DOMContentLoaded", (event) => {
        // clientUtils.setLoadingStatus(true, "loading-patients-display", "retrieving patient list ..");

        let preloadedPatientInquiryData= sessionStorage.getItem("preloadedPatientInquiryData");
        
        // If the serve response has been received before, use the preloaded version instead.
        if (preloadedPatientInquiryData) {
            responseCallback(JSON.parse(preloadedPatientInquiryData));
            return;
        }

        var newClientPost = new clientUtils.ClientPost(
            "requestUserClients",
            clientUtils.getCookie("accessToken"),
            responseCallback
        );
        
        clientUtils.webPost(newClientPost);
    });
</script>