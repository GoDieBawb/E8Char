<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" type="text/css" href="bootstrap/bootstrap.css" >
		<link rel="stylesheet" type="text/css" href="elechart/elechart.css" >
		<link rel="stylesheet" type="text/css" href="fontawesome/css/all.min.css" >
		<link rel="icon" type="image/x-icon" href="images/favicon.ico">
		<script defer src="bootstrap/bootstrap.bundle.min.js"></script>
		<script defer src="scripts/clientutils.js"></script>
		<title>Services</title>
	</head>
	<body>
		<div class="d-flex" id="wrapper">
			<!-- Sidebar -->
			<div class="bg-white shadow border-end" id="sidebar-wrapper">
				<div class="sidebar-heading text-center py-4 color-elechart-deep fs-4 fw-bold text-uppercase border-bm"><i
						class="fas fa-user me-2"></i>Services</div>
				<div class="list-group list-group-flush">
					<button type="button" class="btn btn-success rounded-0 mb-1 fw-bold" id="btn-new-service" onclick="switchView(1)"><i class="fas fa-user-tag me-2"></i>New Service</button>
					<button type="button" class="btn btn-success rounded-0 mb-1 fw-bold" id="btn-cancel" onclick="switchView(0)" hidden>Cancel</button>
					<button type="button" class="btn btn-success rounded-0 fw-bold" id="btn-dashboard" onclick="clientUtils.goto('PatientDashboard')"><i class="fas fa-arrow-alt-circle-left me-2"></i>Dashboard</button>
				</div>
			</div>
			<!-- /#sidebar-wrapper -->

			<!-- Read-only service record view -->
			<div class="bg-elechart-light elechart-bg w-100" id="readonly-service-view">
                <div class="container-fluid px-4">
                    <div class="row my-4">
                        <div class="col-2 overflow-y-scroll overflow-x-hidden">
                            <div class="row">
                                <div class="col p-0" id="service-group-list">
                                </div>
                            </div>
                        </div>
                        <div class="col bg-white shadow-sm border py-2">
                            <p class="h3">Service Records</p>
                            <div class="overflow-y-scroll overflow-x-hidden" id="service-record-list">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row full-height-minus-300 bg-white shadow-sm rounded border">
                        <iframe class="py-3" id="service-form-viewer" src="InstructionalMessage">
                        </iframe>
                    </div>
                </div>
            </div>

            <!-- Service creation form view -->
            <div class="bg-elechart-light elechart-bg w-100" id="creation-service-view" hidden>
                <div class="container-fluid px-4 pt-4">
                    <div class="row mt-4">
                        <div class="col-3 my-4">
                            <div class="bg-white rounded border">
                                <h3 class="text-center">Service Type</h3>
                                <div class="overflow-y-scroll overflow-x-hidden">
                                    <div id="service-creation-group-list">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col full-height-minus-100 bg-white shadow-sm rounded border">
                            <iframe class="py-3" id="service-creation-form-viewer" src="InstructionalMessage"></iframe>
                        </div>
                    </div>
                </div>
            </div>
		</div>
	</body>
</html>

<script>
    "use strict"

    let serviceGroupList = {};
    let serviceGroupOptionsList = []; // For creating a new service form.
    let serviceGroupRecordsList = [];
    var selectedGroupRecord = null;

    // This object represents a service entry in the services page.
    function ServiceGroup(name) {
        this.name = name;
        this.records = new Array(); // Array<ServiceRecord>
        this.HTMLReference = new DOMParser().parseFromString(`<button class="btn btn-light rounded-0 shadow-sm mb-1 w-100">${this.name}</button>`, "text/html").querySelector(".btn");
        this.serviceFile = null;

        this.select = function(viewMode) {
            for (const serviceName in serviceGroupList)
                serviceGroupList[serviceName].deselect(viewMode)

            this.HTMLReference.classList.add("pressed");
            
            const serviceRecordsListHTML = document.querySelector("#service-record-list");
            clientUtils.clearHTMLList(serviceRecordsListHTML);
        
            for (const record of this.records)
                serviceRecordsListHTML.appendChild(record.HTMLReference);
        }

        this.deselect = function(viewMode) {
            this.HTMLReference.classList.remove("pressed");
        }
        
        this.HTMLReference.addEventListener("click", () => this.select(0), false);
        document.getElementById("service-group-list").appendChild(this.HTMLReference);
    }

    // Represents an option for creating a new service form.
    function ServiceGroupOption(name, serviceFile) {
        this.name = name;
        this.HTMLReference = new DOMParser().parseFromString(`<button class="btn btn-light rounded-0 shadow-sm mb-1 w-100">${this.name}</button>`, "text/html").querySelector(".btn");
        this.serviceFile = serviceFile;

        this.select = function(viewMode) {
            for (const serviceGroupOption in serviceGroupOptionsList)
                serviceGroupOptionsList[serviceGroupOption].deselect(viewMode)

            this.HTMLReference.classList.add("pressed");
            document.querySelector("#service-creation-form-viewer").src = this.serviceFile;
        }

        this.deselect = function(viewMode) {
            this.HTMLReference.classList.remove("pressed");
        }
        
        this.HTMLReference.addEventListener("click", () => this.select(0), false);
        document.querySelector("#service-creation-group-list").appendChild(this.HTMLReference);
    }

    // This object represents a record belonging to a specific service.
    function ServiceRecord(recordData) {
        this.data = recordData;
        this.HTMLReference = new DOMParser().parseFromString(
            `<button class="btn-elechart text-start my-1 py-1">
                <span class="col mx-4">#${recordData.serviceId}</span>|
                <span class="col mx-4">${recordData.serviceType}</span>|
                <span class="col mx-4">${clientUtils.getCookie("clientName")}</span>|
                <span class="col mx-4">d.o.b</span>|
                <span class="col mx-4">servicing doctor</span>|
                <span class="col mx-4">${recordData.date}</span>
            </button>`, "text/html").querySelector(".btn-elechart");

        this.select = function() {
            serviceGroupRecordsList.forEach(record => {
                if (this !== record)
                    record.deselect();
            });

            selectedGroupRecord = this;
            this.HTMLReference.classList.add("selected");

            // Display the matching service form file.
            document.querySelector("#service-form-viewer").setAttribute("src", this.data.serviceFile);
        }

        this.deselect = function() {
            this.HTMLReference.classList.remove("selected");
        }

        // Make the select() function for this record listen for clicks.
        this.HTMLReference.addEventListener("click", () => this.select(), false);
    }
    
    // Handles the response from the server for the client response.
    function responseCallback(serverResponse) {
        if (serverResponse.outcome == "failed") {
            // Alert and return if failed
            alert("Post Failed: " + serverResponse.responseType);
            return;
        }

        console.log(serverResponse);

        // load up the services and populate their corresponding records
        for (const serviceGroupName in serverResponse.serviceMap) {
            const serviceGroupItems = serverResponse.serviceMap[serviceGroupName];

            for (const record of serviceGroupItems) {
                const serviceName = record.serviceType;
                let specificServiceGroup = serviceGroupList[serviceName];
                
                if (specificServiceGroup == null) {
                    // add a new service group
                    specificServiceGroup = new ServiceGroup(serviceName);
                    specificServiceGroup.serviceFile = record.serviceFile;
                    serviceGroupList[serviceName] = specificServiceGroup;
                }
                
                // add the service record in this existing service group
                let newRecord = new ServiceRecord(record);
                specificServiceGroup.records.push(newRecord);
                serviceGroupRecordsList.push(newRecord);
            }
        }

        // Populate service group options to allow for service form creation.
        for (const serviceGroupOption in serverResponse.availableServices) {
            let serviceFile = serverResponse.availableServices[serviceGroupOption];
            serviceGroupOptionsList.push(new ServiceGroupOption(serviceGroupOption, serviceFile));
        }

        //clientUtils.setLoadingStatus(false, "loading-services-display");
    }

    window.onload = function() {
        clientUtils.changeInstructionalMessage(document.querySelector("#service-form-viewer"), "To view a record, select a service type tab, then select a record entry on the top left window.");

        //clientUtils.setNavigationPath(`Dashboard > ${clientUtils.getCookie("clientName")} > Services`);
        //clientUtils.setLoadingStatus(true, "loading-services-display", "retrieving patient services ..");

        // retrieve a list of services for this particular patient
        let newClientPost = new clientUtils.ClientPost("requestClientServices", clientUtils.getCookie("accessToken"), responseCallback);
        newClientPost.addParam("clientId", clientUtils.getCookie("clientID"));
        clientUtils.webPost(newClientPost);
    };

    // viewMode: 0 = service viewing, 1 = service creation
    function switchView(viewMode) {
        if (viewMode == 0) {
            document.querySelector("#btn-cancel").setAttribute("hidden", null);
            document.querySelector("#creation-service-view").setAttribute("hidden", null);

            document.querySelector("#btn-new-service").removeAttribute("hidden");
            document.querySelector("#btn-dashboard").removeAttribute("hidden");
            document.querySelector("#readonly-service-view").removeAttribute("hidden");
        }
        else if (viewMode == 1) {
            document.querySelector("#btn-cancel").removeAttribute("hidden");
            document.querySelector("#creation-service-view").removeAttribute("hidden");
            document.querySelector("#btn-new-service").setAttribute("hidden", null);
            document.querySelector("#btn-dashboard").setAttribute("hidden", null);
            document.querySelector("#readonly-service-view").setAttribute("hidden", null);
        }
    }
</script>