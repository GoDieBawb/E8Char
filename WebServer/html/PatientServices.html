<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" type="text/css" href="bootstrap/bootstrap.css" >
		<link rel="stylesheet" type="text/css" href="elechart/elechart.css" >
		<link rel="stylesheet" type="text/css" href="fontawesome/css/all.min.css" >
		<link rel="icon" type="image/x-icon" href="images/favicon.ico">
		<script defer src="bootstrap/bootstrap.bundle.min.js"></script>
		<script defer src="scripts/clientutils.js"></script>
		<title>Services</title>
	</head>

	<body>
		<div class="d-flex" id="wrapper">
			<!-- Sidebar -->
			<div class="bg-white" id="sidebar-wrapper">
				<div class="sidebar-heading text-center py-4 color-elechart-deep fs-4 fw-bold text-uppercase border-bm"><i
						class="fas fa-user me-2"></i>Services</div>
				<div class="list-group list-group-flush">
					<button type="button" class="btn btn-success rounded-0 mb-1 fw-bold"><i class="fas fa-user-tag me-2"></i>New Service</button>
					<button type="button" class="btn btn-success rounded-0 fw-bold" onclick="clientUtils.goto('PatientDashboard')"><i class="fas fa-arrow-alt-circle-left me-2"></i>Dashboard</button>
				</div>
			</div>
			<!-- /#sidebar-wrapper -->

			<!-- Page Content & Nav Bar -->
			<div class="bg-elechart-light" id="page-content-wrapper">
                <div class="row">
                    <div class="col">
                        
                    </div>
                    <div class="col"></div>
                </div>
			</div>
		</div>
	</body>
</html>

<script>
    "use strict"

    let serviceGroupList = {};
    let serviceGroupRecordsList = [];
    var selectedGroupRecord = null;

    // This object represents a service entry in the services page.
    function ServiceGroup(name) {
        this.name = name;
        this.records = new Array(); // Array<ServiceRecord>
        this.HTMLReference =  new DOMParser().parseFromString(
            `<div class="service-group mt-2 px-2">
                <h3>${name}</h3>
            </div>
            `, "text/html").querySelector(".service-group");
        
        this.add = function(record) {
            this.records.push(record);
            this.HTMLReference.innerHTML += `
                <div class="service-group-item mb-2">
                    <button class="btn btn-service-record w-100 text-start">
                        <span class="me-3">(${record.serviceId})</span><span class="me-2">${record.date}</span>|<span class="ms-2">${clientUtils.getCookie("clientFriendlyName")}</span>
                    </button>
                </div>`;
        }

        //document.getElementById("service-group-list").appendChild(this.HTMLReference);
    }

    // This object represents a record belonging to a specific service.
    function ServiceRecord(recordData) {
        this.data = recordData;
        this.HTMLReference = new DOMParser().parseFromString(
            `<div class="service-group-item mb-2">
                <button class="btn btn-service-record w-100 text-start">
                    <span class="me-3">(${recordData.serviceId})</span><span class="me-2">${recordData.date}</span>|<span class="ms-2">${clientUtils.getCookie("clientFriendlyName")}</span>
                </button>
            </div>`, "text/html").querySelector(".service-group-item");

        this.select = function() {
            serviceGroupRecordsList.forEach(record => {
                if (this !== record)
                    record.deselect();
            });

            selectedGroupRecord = this;
            this.HTMLReference.querySelector(".btn-service-record").classList.add("selected");

            // Show the matching service form file to the right.
            //document.querySelector("#service-group-form").setAttribute("src", this.data.serviceFile);
        }

        this.deselect = function() {
            this.HTMLReference.querySelector(".btn-service-record").classList.remove("selected");
        }

        // Make the select() function for this record listen for clicks.
        this.HTMLReference.querySelector(".btn-service-record").addEventListener("click", () => this.select(), false);
    }
    
    // Handles the response from the server for the client response.
    function responseCallback(serverResponse) {
        if (serverResponse.outcome == "failed") {
            // Alert and return if failed
            alert("Post Failed: " + serverResponse.responseType);
            return;
        }

        console.log(serverResponse);

        // load up the services and populate their corresponding records
        for (const serviceGroup in serverResponse.serviceMap) {
            const serviceGroupItems = serverResponse.serviceMap[serviceGroup];

            for (const record of serviceGroupItems) {
                const serviceName = record.serviceType;
                let specificServiceGroup = serviceGroupList[serviceName];
                
                if (specificServiceGroup == null) {
                    // add a new service group
                    specificServiceGroup = new ServiceGroup(serviceName);
                    serviceGroupList[serviceName] = specificServiceGroup;
                }
                
                // add the service record in this existing service group
                let newRecord = new ServiceRecord(record);
                specificServiceGroup.records.push(newRecord);
                serviceGroupRecordsList.push(newRecord);
                specificServiceGroup.HTMLReference.appendChild(newRecord.HTMLReference);
            }
        }

        console.log(serviceGroupRecordsList);

        //clientUtils.setLoadingStatus(false, "loading-services-display");
    }

    window.onload = function() {
        //clientUtils.setNavigationPath(`Dashboard > ${clientUtils.getCookie("clientFriendlyName")} > Services`);
        //clientUtils.setLoadingStatus(true, "loading-services-display", "retrieving patient services ..");

        // retrieve a list of services for this particular patient
        let newClientPost = new clientUtils.ClientPost(
            "requestClientServices",
            clientUtils.getCookie("accessToken"),
            responseCallback
        );

        newClientPost.addParam("clientId", clientUtils.getCookie("clientID"));
        clientUtils.webPost(newClientPost);
    };

    ////////////////////////////////////////////////

    function setElementVisiblity(elementName, visible) {
        let el = document.getElementById(elementName);
        el.hidden = !visible;
    }

    function showServiceList(elementNameToHide) {
        if (elementNameToHide != null)
            setElementVisiblity(elementNameToHide, false);

        setElementVisiblity('view-services-list', true);
        clientUtils.setNavigationPath(`Dashboard > ${clientUtils.getCookie("clientFriendlyName")} > Services`);
    }

    function showCreationForm() {
        if (!selectedServiceEntry) {
            console.error("Tried showing the creation form for this service but its service isn't selected!");
            return;
        }

        let creationFormView = document.getElementById("view-creation-form")
        creationFormView.innerHTML = "";
        creationFormView.setAttribute("src", `./${selectedServiceEntry.serviceFile}`);
        creationFormView.setAttribute("height", 500);
        creationFormView.hidden = false;
    }
</script>