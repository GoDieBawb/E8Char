<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="bootstrap/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/custom.css">
        <script src="scripts/clientutils.js"></script>
    </head>
    <body>
        <div>
            <a href="Dashboard.html">Dashboard</a>
            <div id="navigation-path-bar"></div>
            <h2>Services</h2>
            <hr>
            
            <div id="view-services-list">
                <label>Filter</label>
                <input type="text">
                <br>
                <br>
                <div id="services-list">
                    <span id="loading-services-display" hidden><img src="images/load_display.gif" width="64" height="64"></img><span></span></span>
                </div>
                <br>
                <button onclick="newService()">New Service</button>
            </div>

            <div id="view-selected-service" hidden>
                <div>
                    <!-- list of service records go in this div block -->
                </div>
                <br>
                <button onclick="showServiceList('view-selected-service')">Services List</button>
                <button onclick="showCreationForm()">New Service Record</button>
                <br>
                <br>
                <iframe id="view-creation-form" src="./PhysicalEvaluation.html" title="new service form" style="width:-webkit-fill-available;" hidden></iframe>
            </div>
        </div>
    </body>
</html>

<script>
    "use strict"

    var loadedServices = {};
    var selectedServiceEntry = null;

    window.onload = function() {
        clientUtils.setNavigationPath(`Dashboard > ${clientUtils.getCookie("clientFriendlyName")} > Services`);
        clientUtils.setLoadingStatus(true, "loading-services-display", "retrieving patient services ..");

        // retrieve a list of services for this particular patient
        let newClientPost = new clientUtils.ClientPost(
            "requestClientServices",
            clientUtils.getCookie("accessToken"),
            responseCallback
        );

        newClientPost.addParam("clientId", clientUtils.getCookie("clientID"));

        clientUtils.webPost(newClientPost);
    };

    // This object represents a service entry in the services page.
    function ServiceEntry(serviceID, serviceType, serviceFile) {
        this.serviceID = serviceID;
        this.serviceType = serviceType;
        this.serviceFile = serviceFile;
        this.serviceRecords = new Array();
        this.HTMLID = "serviceEntryUI" + serviceID;
        this.HTMLReference = new DOMParser().parseFromString(
            `<div id="${this.HTMLID}">
                <h4>${serviceType}</h4>
                <a href="#">link to ${serviceType} list</a>
            </div>`, "text/html").getElementById(this.HTMLID);

        this.select = function() {
            setElementVisiblity("view-services-list", false);
            setElementVisiblity("view-selected-service", true);

            let recordsList = document.getElementById("view-selected-service").firstElementChild;
            recordsList.innerHTML = "";

            this.serviceRecords.forEach(record => {
                recordsList.innerHTML += 
                    `<div>
                        <h6>${record.serviceType}</h6>
                        <div>${record.date}</div>
                        <button>View Record</button>
                    </div>`;
            });

            clientUtils.setNavigationPath(`Dashboard > ${clientUtils.getCookie("clientFriendlyName")} > Services > ${this.serviceType}`);
            selectedServiceEntry = this;
        }
    }
    
    //Handles the response from the server for the client response
    function responseCallback(serverResponse) {
        //Alert and return if failed
        if (serverResponse.outcome == "failed") {
            alert("Post Failed: " + serverResponse.responseType);
            return;
        }

        // Load up the services and populate their corresponding records
        let servicesList = document.getElementById("services-list");

        serverResponse.services.forEach(serv => {
            let loadedEntry = loadedServices[serv.serviceType];

            if (loadedEntry == null) {
                const newServiceCard = new ServiceEntry(serv.serviceId, serv.serviceType, serv.serviceFile);
                loadedServices[serv.serviceType] = newServiceCard;
                loadedEntry = newServiceCard;
                
                servicesList.appendChild(newServiceCard.HTMLReference);
                newServiceCard.HTMLReference.children.findInParticular("tag", "a").addEventListener("click", () => newServiceCard.select(), false);
            }
            
            loadedEntry.serviceRecords.push(serv);
        });

        clientUtils.setLoadingStatus(false, "loading-services-display");

        console.log(serverResponse.services);
    }

    ////////////////////////////////////////////////

    function setElementVisiblity(elementName, visible) {
        let el = document.getElementById(elementName);
        el.hidden = !visible;
    }

    function showServiceList(elementNameToHide) {
        if (elementNameToHide != null)
            setElementVisiblity(elementNameToHide, false);

        setElementVisiblity('view-services-list', true);
        clientUtils.setNavigationPath(`Dashboard > Client #${clientUtils.getCookie("clientID")} > Services`);
    }

    function showCreationForm() {
        if (!selectedServiceEntry) {
            console.error("Tried showing the creation form for this service but its service isn't selected!");
            return;
        }

        let creationFormView = document.getElementById("view-creation-form")
        creationFormView.innerHTML = "";
        creationFormView.setAttribute("src", `./${selectedServiceEntry.serviceFile}`);
        creationFormView.setAttribute("height", 500);
        creationFormView.hidden = false;
    }
</script>